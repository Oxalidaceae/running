<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Tmap 출발-경유-출발 (보행자·JSON)</title>
  <!-- Tmap SDK - .env.local의 VITE_TMAP_API_KEY와 동일한 키 사용 -->
  <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=eeVNdffaIL4ehi9H8tRja3ehIsqyAMBq6wnsNAHX"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family: system-ui, sans-serif; overflow:hidden; }
    #map { width:100%; height:100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    async function main() {
      // URL 파라미터에서 좌표 가져오기
      const urlParams = new URLSearchParams(window.location.search);
      const appKey = "eeVNdffaIL4ehi9H8tRja3ehIsqyAMBq6wnsNAHX"; // .env.local의 VITE_TMAP_API_KEY와 동일

      // URL 파라미터에서 좌표 가져오기
      // origin 파라미터 파싱
      const originParam = urlParams.get('origin');
      if (!originParam) {
        console.error("URL에 origin 파라미터가 필요합니다.");
        return;
      }
      const [originLat, originLng] = originParam.split(',').map(Number);
      if (isNaN(originLat) || isNaN(originLng)) {
        console.error("origin 좌표 형식이 올바르지 않습니다.");
        return;
      }
      const origin = { lat: originLat, lng: originLng };

      // waypoint 파라미터 파싱
      const waypointParam = urlParams.get('waypoint');
      if (!waypointParam) {
        console.error("URL에 waypoint 파라미터가 필요합니다.");
        return;
      }
      const [waypointLat, waypointLng] = waypointParam.split(',').map(Number);
      if (isNaN(waypointLat) || isNaN(waypointLng)) {
        console.error("waypoint 좌표 형식이 올바르지 않습니다.");
        return;
      }
      const waypoint = { lat: waypointLat, lng: waypointLng };

      // 지도 생성
      const map = new Tmapv2.Map("map", {
        center: new Tmapv2.LatLng(origin.lat, origin.lng),
        width: "100%", 
        height: "100vh",
        zoom: 15, 
        zoomControl: true, 
        scrollwheel: true
      });

      // 마커 (크고 눈에 띄게 수정)
      const ICON_S = "https://tmapapi.tmapmobility.com/upload/tmap/marker/pin_r_m_s.png";
      const ICON_E = "https://tmapapi.tmapmobility.com/upload/tmap/marker/pin_r_m_e.png";
      const ICON_P = "https://tmapapi.tmapmobility.com/upload/tmap/marker/pin_r_m_p.png"; // 더 눈에 띄는 마커

      const mS = new Tmapv2.Marker({
        position: new Tmapv2.LatLng(origin.lat, origin.lng),
        icon: ICON_S, 
        iconSize: new Tmapv2.Size(24, 38), // 2배 크기
        map
      });
      const mE = new Tmapv2.Marker({
        position: new Tmapv2.LatLng(origin.lat, origin.lng),
        icon: ICON_E, 
        iconSize: new Tmapv2.Size(24, 38), // 2배 크기
        map
      });
      const mW = new Tmapv2.Marker({
        position: new Tmapv2.LatLng(waypoint.lat, waypoint.lng),
        icon: ICON_P, 
        iconSize: new Tmapv2.Size(24, 38), // 훨씬 크게
        map
      });

      // 보행자 경로: passList = "경도,위도_..." (여기선 1곳)
      const passList = `${waypoint.lng},${waypoint.lat}`;

      const url = "https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&format=json";
      const formBody = new URLSearchParams({
        startX: String(origin.lng),
        startY: String(origin.lat),
        endX:   String(origin.lng),
        endY:   String(origin.lat),
        passList,
        reqCoordType: "WGS84GEO",
        resCoordType: "EPSG3857",
        startName: "출발지",
        endName:   "도착지",
      });

      let res, data;
      try {
        res = await fetch(url, {
          method: "POST",
          mode: "cors",
          headers: new Headers({
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded",
            "appKey": appKey,
          }),
          body: formBody.toString(),
        });

        // form 실패 시 JSON 바디로 재시도
        if (!res.ok) {
          console.warn("x-www-form-urlencoded 실패, JSON으로 재시도");
          res = await fetch("https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1", {
            method: "POST",
            mode: "cors",
            headers: new Headers({
              "Accept": "application/json",
              "Content-Type": "application/json",
              "appKey": appKey,
            }),
            body: JSON.stringify({
              startX: origin.lng, startY: origin.lat,
              endX: origin.lng,   endY: origin.lat,
              passList,
              reqCoordType: "WGS84GEO",
              resCoordType: "EPSG3857",
              startName: "출발지",
              endName:   "도착지",
            }),
          });
        }
        if (!res.ok) {
          const errorText = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        data = await res.json();
      } catch (e) {
        console.error("Tmap API error:", e);
        return;
      }

      const features = Array.isArray(data?.features) ? data.features : [];
      if (!features.length) {
        console.warn("경로 데이터 없음");
        return;
      }

      // 라인 그리기 (EPSG3857 → WGS84 변환)
      const pts = [];
      const { Projection } = Tmapv2;
      for (const f of features) {
        if (f?.geometry?.type === "LineString") {
          for (const c of f.geometry.coordinates || []) {
            const wgs = Projection.convertEPSG3857ToWGS84GEO(new Tmapv2.Point(c[0], c[1]));
            pts.push(new Tmapv2.LatLng(wgs._lat, wgs._lng));
          }
        }
      }
      if (pts.length) {
        new Tmapv2.Polyline({ path: pts, strokeColor: "#DD0000", strokeWeight: 6, map });
        const bounds = new Tmapv2.LatLngBounds();
        pts.forEach(p => bounds.extend(p));
        map.fitBounds(bounds);
      }
    }

    // SDK 로드 확인 후 실행
    window.addEventListener("load", () => {
      if (!window.Tmapv2) {
        console.error("Tmap JS SDK가 로드되지 않았습니다.");
        return;
      }
      main().catch(err => console.error("Tmap 초기화 오류:", err));
    });
  </script>
</body>
</html>